machine:
  environment:
    CONTAINER_NAME: quay.io/redsift/baseos
    ETCD_V: v2.1.1
    S6_V: v1.14.0.0
    NANO_MSG: 0.6-beta
  services:
    - docker
      
checkout:
  post:
    - git fetch --tags
    
dependencies:
  override:
    - curl -L  https://github.com/coreos/etcd/releases/download/$ETCD_V/etcd-$ETCD_V-linux-amd64.tar.gz | tar xz && cp etcd-$ETCD_V-linux-amd64/etcdctl root/usr/bin/etcdctl  
    - curl -L  https://github.com/nanomsg/nanomsg/archive/$NANO_MSG.tar.gz | tar xz
    - cd nanomsg-$NANO_MSG; sh autogen.sh && ./configure --prefix=$(readlink -f ./package) && make && make check && sudo make install && cp -r ./package/* ../root/.
    - cd root; curl -k -L https://github.com/just-containers/s6-overlay/releases/download/$S6_V/s6-overlay-amd64.tar.gz | tar xz
    - docker info
    - |
        sudo docker build -t $CONTAINER_NAME .
        VERSION=$(git describe --exact-match --tags 2>/dev/null || git rev-parse --short HEAD)
        echo "Tagging as $CONTAINER_NAME:$VERSION"
        docker tag $CONTAINER_NAME:latest $CONTAINER_NAME:$VERSION
    
test:
  override:
    - docker run -d $CONTAINER_NAME; sleep 10    
    
deployment:
  prod:
    branch: master
    commands:
      - docker login -e $QUAY_EMAIL -u $QUAY_USER -p $QUAY_PASS quay.io
      - docker push $CONTAINER_NAME
    